name: SuperClaude Unified Handler

# Prevent duplicate workflow runs
concurrency:
  group: superclaude-${{ github.event.issue.number || github.event.comment.id || github.event.number }}
  cancel-in-progress: false

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  superclaude-handler:
    # Prevent duplicate runs with strict conditions
    if: |
      (github.event_name == 'issues' &&
       contains(github.event.issue.labels.*.name, 'claude-fix') &&
       github.event.action == 'labeled') ||
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@claude') &&
       github.event.action == 'created' &&
       github.actor != 'claude[bot]') ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '@claude') &&
       github.event.action == 'created') ||
      (github.event_name == 'pull_request_review' &&
       contains(github.event.review.body, '@claude') &&
       github.event.action == 'submitted')

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run SuperClaude Framework
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          base_branch: main
          branch_prefix: superclaude/
          track_progress: true
          settings: |
            {
              "workingDirectory": ".",
              "environmentVariables": {
                "NODE_ENV": "development"
              }
            }
          prompt: |
            ðŸš¨ **MANDATORY: CREATE PULL REQUEST WITH CODE IMPLEMENTATION** ðŸš¨

            **CRITICAL SUCCESS CRITERIA**: This task is ONLY successful if a Pull Request is created.

            **STEP-BY-STEP MANDATORY WORKFLOW**:

            **Phase 1: Create Branch**
            1. Run: `git status` (check current state)
            2. Run: `git checkout -b superclaude/issue-${{ github.event.issue.number }}`
            3. Verify branch created: `git branch`

            **Phase 2: Implement Code**
            4. Add leaderboard HTML section to index.html (after existing game elements)
            5. Add leaderboard CSS styling (dark gaming theme, glassmorphism)
            6. Add leaderboard JavaScript functions to game.js
            7. Verify integration with existing scoring system

            **Phase 3: Commit & Push** (MOST CRITICAL - DO NOT SKIP)
            8. Run: `git add .` (stage all changes)
            9. Run: `git status` (verify files staged)
            10. Run: `git commit -m "feat: add gaming leaderboard UI component"`
            11. Run: `git push origin superclaude/issue-${{ github.event.issue.number }}`

            **Phase 4: Create PR** (FINAL REQUIREMENT)
            12. Use GitHub API or gh CLI to create PR
            13. Link PR to issue #${{ github.event.issue.number }}
            14. Verify PR was created successfully

            **LEADERBOARD REQUIREMENTS**:
            - Dark gaming theme matching existing design
            - Top 5 player rankings with scores
            - Responsive glassmorphism styling
            - Real-time score updates from game.js

            **INTEGRATION**: Add leaderboard div after game canvas, connect to existing score variable.

            **FAILURE = NO PR CREATED. SUCCESS = WORKING PR WITH CODE.**

            Execute every step above. DO NOT STOP until Pull Request exists.

          claude_args: '--allowed-tools "*" --max-turns 15'